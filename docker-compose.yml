services:
  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: 'proxy-dns --port 5053 --upstream https://dns.cloudflare.com/dns-query --upstream https://dns.google/dns-query'
    networks:
      - dns_network
    
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    restart: unless-stopped
    ports:
      # DNS Ports
      - "53:53/tcp"
      - "53:53/udp"
      # Default HTTP Port
      - "80:80/tcp"
      # Default HTTPS Port. FTL will generate a self-signed certificate
      - "443:443/tcp"
      # Uncomment the line below if you want Pi-hole as your DHCP server
      #- "67:67/udp"
    environment:
      # Set your timezone
      TZ: ${TIMEZONE:-America/New_York}
      # Web interface password
      FTLCONF_webserver_api_password: ${PIHOLE_WEBPASSWORD:-admin}
      # Configure Pi-hole to use cloudflared for DNS
      FTLCONF_dns_upstreams: 127.0.0.1#5053
      # Listen on all interfaces
      FTLCONF_dns_listeningMode: all
      # Enable DNSSEC
      FTLCONF_dns_dnssec: true
      # Disable bogus private reverse lookups
      FTLCONF_dns_bogus_priv: true
      # Enable query logging
      FTLCONF_webserver_query_logging: true
      # Set web theme
      FTLCONF_gui_theme: default-dark
    volumes:
      # For persisting Pi-hole's databases and configuration
      - './container_data/pihole/etc-pihole:/etc/pihole'
    depends_on:
      - cloudflared
    networks:
      - dns_network
    cap_add:
      # Required if you are using Pi-hole as your DHCP server
      - NET_ADMIN
      # Optional, gives Pi-hole more processing priority
      - SYS_NICE

networks:
  dns_network:
    driver: bridge